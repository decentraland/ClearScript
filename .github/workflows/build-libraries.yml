name: Build ClearScript (Linux, Ubuntu 20.04)

on:
  workflow_dispatch:
    inputs:
      clearscript_path:
        description: "Path to ClearScript root ('.' if this repo is ClearScript; otherwise a subfolder)"
        required: false
        default: "ClearScript"

jobs:
  build:
    runs-on: ubuntu-latest
    container:
      image: ubuntu:20.04   # glibc 2.31

    defaults:
      run:
        shell: bash

    strategy:
      fail-fast: false
      matrix:
        cpu: [x64]       
        config: [Release] 

    env:
      DEBIAN_FRONTEND: noninteractive
      CLEAR_SCRIPT_DIR: ${{ github.event.inputs.clearscript_path != '' && github.event.inputs.clearscript_path || '.' }}

    steps:
      - name: Show base image + glibc
        run: |
          cat /etc/os-release
          ldd --version || true

      - name: Install prerequisites
        run: |
          apt-get update
          apt-get install -y --no-install-recommends \
            ca-certificates apt-transport-https software-properties-common \
            git wget curl make clang pkg-config build-essential gnupg dos2unix file tree

      - name: Install .NET 8 SDK
        run: |
          wget https://packages.microsoft.com/config/ubuntu/20.04/packages-microsoft-prod.deb -O packages-microsoft-prod.deb
          dpkg -i packages-microsoft-prod.deb
          rm -f packages-microsoft-prod.deb
          apt-get update
          apt-get install -y dotnet-sdk-8.0

      - name: Checkout
        uses: actions/checkout@v4

      - name: Normalize CLEAR_SCRIPT_DIR when building this repo directly
        if: ${{ github.event.inputs.clearscript_path == '' }}
        run: echo "CLEAR_SCRIPT_DIR=.">> $GITHUB_ENV

      - name: Cross toolchains
        if: ${{ matrix.cpu != 'x64' }}
        run: |
          case "${{ matrix.cpu }}" in
            arm)   apt-get install -y g++-10-arm-linux-gnueabihf ;;
            arm64) apt-get install -y g++-10-aarch64-linux-gnu ;;
          esac

      - name: Fix script permissions (and line endings)
        working-directory: ${{ env.CLEAR_SCRIPT_DIR }}
        run: |
          find Unix -type f -name "*.sh" -print0 | xargs -0 chmod +x
          find Unix -type f -name "*.sh" -print0 | xargs -0 dos2unix || true

      - name: Build ClearScript
        working-directory: ${{ env.CLEAR_SCRIPT_DIR }}
        run: |
          set -euxo pipefail
          MAKE_ARGS=()
          if [[ "${{ matrix.config }}" == "Debug" ]]; then MAKE_ARGS+=("DEBUG=1"); fi
          case "${{ matrix.cpu }}" in
            arm)   MAKE_ARGS+=("CPU=arm") ;;
            arm64) MAKE_ARGS+=("CPU=arm64") ;;
          esac
          echo "make -f Unix/Makefile ${MAKE_ARGS[*]}"
          make -f Unix/Makefile "${MAKE_ARGS[@]}"

      - name: Inspect built libs (ldd)
        working-directory: ${{ env.CLEAR_SCRIPT_DIR }}
        run: |
          find bin -type f -name "*.so" -print | while read so; do
            echo "---- $so ----"
            file "$so" || true
            ldd "$so" || true
          done

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: clearscript-${{ matrix.cpu }}-${{ matrix.config }}-ubuntu2004
          path: ${{ env.CLEAR_SCRIPT_DIR }}/bin/${{ matrix.config }}/
          if-no-files-found: error
